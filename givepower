local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TextChatService = game:GetService("TextChatService")
local warnCommand = '/warns'
local givePowerCommand = '/givepower'
local Admins = {"dgthgcnfhhbsd", "AliKhammas", "iannnnnnnnnnnnn_n", "simhean", "AK_ADMEN1"}
local playersWithPower = {}
local oldChat = false

-- Check if the old chat system is being used
if ReplicatedStorage:FindFirstChild('DefaultChatSystemChatEvents') then
    oldChat = true
end

-- Function to send a message
local function Chat(msg, player)
    if oldChat then
        ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer(msg, "All")
    else
        TextChatService.TextChannels.RBXGeneral:SendAsync(msg)
    end
end

local function onPlayerChatted(player, message)
    local args = message:split(" ")
    local command = string.lower(args[1])

    if command == string.lower(givePowerCommand) and args[2] then
        local targetPlayer = Players:FindFirstChild(args[2])
        if not targetPlayer then
            for _, p in ipairs(Players:GetPlayers()) do
                if string.lower(p.DisplayName) == string.lower(args[2]) then
                    targetPlayer = p
                    break
                end
            end
        end
        
        if targetPlayer then
            if not playersWithPower[targetPlayer.Name] then
                playersWithPower[targetPlayer.Name] = true
                Chat(targetPlayer.DisplayName .. ", you have been given warning power by " .. player.DisplayName, targetPlayer)
            end
            return  -- Ensure only one message is sent
        else
            Chat("Player not found: " .. args[2], player)
            return
        end
    elseif command == string.lower(warnCommand) and args[2] then
        if playersWithPower[player.Name] or table.find(Admins, player.Name) then
            local victimPlayer = Players:FindFirstChild(args[2])
            if not victimPlayer then
                for _, p in ipairs(Players:GetPlayers()) do
                    if string.lower(p.DisplayName) == string.lower(args[2]) then
                        victimPlayer = p
                        break
                    end
                end
            end
            
            if victimPlayer then
                for i = 1, 100 do
                    ReplicatedStorage.Notification.PlayerSelectedEvent:FireServer(victimPlayer.Name)
                end
                Chat("You have warned " .. victimPlayer.DisplayName .. ".", player) -- Confirmation for the admin
                return  -- Ensure only one message is sent
            else
                Chat("Player not found: " .. args[2], player)
                return
            end
        else
            Chat("You do not have permission to warn players.", player)
            return
        end
    end
end

for _, adminName in ipairs(Admins) do
    local admin = Players:FindFirstChild(adminName)
    if admin then
        admin.Chatted:Connect(function(message)
            onPlayerChatted(admin, message)
        end)
    end
end

Players.PlayerAdded:Connect(function(player)
    player.Chatted:Connect(function(message)
        onPlayerChatted(player, message)
    end)
end)

for _, player in ipairs(Players:GetPlayers()) do
    player.Chatted:Connect(function(message)
        onPlayerChatted(player, message)
    end)
end
